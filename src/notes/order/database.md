---
title: 数据库
icon: fa-solid fa-database
category: note
tag:
  - database
---
<!-- ### TODO 看看转储 -->
### 描述一下数据库的锁机制
1. 排他锁 X(Exclusive )锁
   独占一个锁
2. 共享锁 (S)Share锁
读锁，可以与相同操作的人共享
3. 意向锁
4. 行锁
5. 表锁
 
一级锁协议

事务T在修改数据R之前先加了一个X锁，直到事务结束之后才会释放，可以方式丢失修改，保证事务T是可恢复的。

二级锁协议

在一级锁协议基础上增加事务T读取数据R之前加上一个S锁，直到事务结束之后释放。可以防止丢失修改和读脏数据

三级锁协议

在一级封锁协议上加上事务T在读取数据R之前必须对其先加上S锁，直到事务结束后才释放。保证了不丢失修改，不读到脏数据，可重复读。
### 什么是事务？

事务是用户定义的数据库操作序列，具有原子性，是一个不可分割的执行单元。它确保数据库操作的一致性和完整性，同时也是恢复技术和并发控制的基本构建块。

### 什么是事务的`ACID`特性？恢复技术能保证事务的哪些特性？

 1. **原子性（Atomicity）**：事务是一个不可分割的工作单元，要么全部执行成功，要么全部失败回滚，不存在部分执行的情况。
 2. **一致性（Consistency）**：事务执行前后，数据库从一个一致性状态转移到另一个一致性状态（读取数据是一样的）
 3. **隔离性（Isolation）**：多个事务并发执行时，每个事务的操作应该与其他事务相互隔离，互不干扰，避免并发执行时数据不一致的问题。
 4. **持久性（Durability）**：一旦事务提交成功，对数据库的修改将永久保存，即使系统发生故障，数据也不会丢失。

 恢复技术通过日志记录和检查点等机制来保证事务的持久性特性。当系统发生故障时，恢复技术可以确保以下特性：

 1. **原子性**：通过事务日志和回滚操作，可以确保事务要么完全执行成功，要么完全回滚，避免部分执行的情况。
 2. **持久性**：通过事务日志和数据备份等手段，可以确保即使系统崩溃，已提交的事务对数据库的修改也能够永久保存。

### 在`SQL`中，定义事务的一般有哪些？
1. `Begin transaction`
2. `commit`
3. `rollback`
4. `set tranction` 设置事务的隔离级别
5. `save point`设置保存点


### 数据库中的`B/S`，`C/S`的区别是什么？
1. 在数据库中，B/S模式指的是通过浏览器和服务器之间的连接来访问数据库的方式。
2. 在数据库中，C/S模式指的是通过客户端应用程序和服务器之间的直接连接来访问数据库的方式。
3. B/S模式更适合基于Web的数据库应用程序，而C/S模式更适合需要更高性能和更复杂操作的数据库应用程序。
### 存储过程和函数分别是什么？ 
1. 存储过程是一组预编译的SQL语句集合，可以被保存在数据库中并被多次调用执行。
2. 函数是一段封装了特定功能的可重用代码块，可以接受参数并返回一个值。
3. 存储过程可以包含多条SQL语句和控制流结构，而函数通常只包含一系列计算逻辑。
### 什么是索引？其作用是？
索引是一种数据结构，用于快速查找和访问数据库表中的特定数据行。
可以帮助加快数据检索速度，优化链接操作，减少磁盘IO
### 什么是主键和外键？他们的特点和用途是什么？
主键：唯一标识表中每一行数据，不允许为空且不能重复。

外键：用于关联两个表的数据，要么为空，要么是另外一个表中的主键 。

用途是：用于建立表与表之间的关联关系，保证数据的完整性和一致性。
### 什么是基本表？什么是视图？两者的区别和联系是什么？
基本表是数据库中存储数据的基本单位
视图是由基本表导出的虚表，是基本表查询结果的逻辑表示，不包含任何数据

==联系== 视图由基本表组成
==区别== 视图是虚表，不包含任何数据，基本表包含数据
### 什么是索引？索引的优缺点是什么
索引时一种数据结构，用于快速查找和访问数据库表中的特定数据行。

优点：加快数据检索速度，优化链接操作，减少磁盘IO

缺点：占用磁盘空间，降低数据插入、更新和删除的性能
### 视图有哪些优点？
1. 简化了用户的操作
2. 一定程度上保护了数据
3. 可以让用户从不同的视角来审视同一组数据
4. 视图提供了一定程度上的逻辑独立性
### 什么是E-R图？E-R模型向关系模型的转换规则是什么？E-R图的设计原则是什么？
是一种用于描述实体之间关系的图形化工具，常用于数据库设计阶段

实体转化成表，属性转化成字段，关系转化成外键，多对多关系转化成连接表。

设计原则：
1. 简单性
2. 完整性
3. 准确性
4. 一致性
5. 可拓展性

### 简述数据库软件系统建立流程

 1. **需求分析**：
    - 确定系统的需求和目标，包括功能需求、性能需求、安全需求等。
 2. **概念设计**：
    - 根据需求分析的结果，设计数据库系统的概念模型，包括实体关系图（ER图）、数据流程图等。
    - 确定数据库中的实体、属性、关系等基本结构。
 3. **逻辑设计**：
    - 将概念模型转换为数据库模式，设计数据库表结构、字段、关系等。
    - 确定数据的存储方式、数据类型、主键、外键等约束。
    - 模型优化
 4. **物理设计**：
    - 根据逻辑设计结果选择合适的数据库管理系统（DBMS）。
    - 设计物理存储结构，包括表空间、索引、分区等。
    - 考虑性能优化和扩展性，确定数据备份和恢复策略。
 5. **实施和编码**：
    - 根据物理设计结果，在选定的DBMS上创建数据库和表结构。
    - 编写数据库操作的存储过程、触发器、视图等。
    - 进行数据导入和数据转换。
 6. **测试**：
    - 进行单元测试、集成测试和系统测试，确保数据库系统的功能和性能符合需求。
    - 进行性能测试、安全测试、容错测试等。
 7. **部署和维护**：
    - 部署数据库系统到生产环境，并进行系统上线。
    - 监控数据库性能，定期备份数据，保证系统的稳定性和安全性。
    - 定期进行维护工作，如优化查询、清理无用数据、更新数据库结构等。

### 什么是数据字典？其作用是什么？

数据字典是描述数据库中数据元素的集合，是元数据（元数据是数据的数据，用来管理数据），不是数据本身。

其包括 1.数据项 2.数据结构 3.数据流 4.数据存储 5.处理过程

其作用包括定义数据元素、描述属性、说明数据关系、提供业务含义，并帮助数据库管理和维护。有助于确保数据的准确性、完整性和一致性。

### 什么是游标？其作用是什么？

游标是系统为用户开放的缓冲区,用于存放`SQL`语句的执行结果。

游标通常用于遍历查询结果集，允许应用程序逐行处理查询结果。

游标的作用包括：

1. 逐行处理数据：游标允许程序逐行访问查询结果集中的数据，这对于需要逐行处理数据的情况非常有用，比如在编写存储过程或批处理作业时。

2. 定位和导航：游标提供了定位和导航查询结果集的能力，允许程序员在结果集中移动到特定的行或记录。

3. 数据检索：通过游标，可以在结果集中检索数据，以便在应用程序中进行处理、分析或展示。

4. 数据更新：游标还可以用于在结果集中更新、删除或插入数据，允许应用程序对查询结果进行修改。

游标操作通常比批量操作效率低，且可能会引起性能问题。开发中尽量使用批操作来替代游标

### 什么是触发器？有什么功能？

触发器（Trigger）是数据库管理系统中的一种特殊类型的存储过程，它会在特定的数据库操作（如插入、更新、删除）发生时自动执行。触发器与表相关联，当满足触发条件时，触发器会被触发执行，从而执行预定义的操作。

触发器的主要功能包括：

1. **数据约束**：可以用来实施数据完整性约束，如检查插入、更新或删除操作是否符合特定条件。
2. **自动化任务**：可以在特定数据库操作发生时自动执行一系列操作，如更新其他表、记录日志、发送通知等。
3. **审计跟踪**：可以用来跟踪数据库操作，记录操作历史以及审计信息。
4. **复杂业务逻辑**：可以用于实现复杂的业务逻辑，确保特定操作的一致性和正确性。
5. **数据同步**：可以用于在多个表之间保持数据同步。

触发器在数据库中起到了重要作用，可以帮助确保数据的完整性、一致性和安全性，同时简化开发人员的工作，减少重复性代码的编写。

### 数据库并发操作带来的数据不一致包括哪些？产生不一致的原因是什么？
1. 丢失修改
   
   两个事务同时修改数据，会导致一个被覆盖
2. 不可重复读
   
   同一个事务两次读的数据不一样
3. 读脏数据
   
   读到了不正确的数据（读到了一个数据，但是因为某个事务被撤销，这个数据被修改了，两个数据不一致，读到的数据是错数据）
### 数据库并发控制的主要技术有哪些？
1. 锁
2. 时间戳 timestamp
3. 乐观控制法
4. 多版本并发控制(MVCC)
### 什么是数据库范式？有什么作用？

- 1NF保证原子性

- 2NF去除非主属性对于主属性的部分依赖

- 3NF去除非主属性对于主属性的传递依赖

- BCNF去除主属性对于主键的部分依赖与传递依赖(**左边都是码**)

- 4NF消除表中的多值依赖(非平凡且非函数依赖的多值依赖)

### 什么是数据库的完整性？其目的是什么？数据库完整性有哪些？
数据库的完整性是指数据库中数据的正确性、一致性和有效性。

目的是维护数据的一致性和可靠性，限制非法操作

1. 实体完整性
2. 参照完整性
3. 用户自己定义的完整性
### 登记日志文件的时候为什么必须要先写日志文件，后写数据库？

日志文件是用来记录事务对数据库的更新操作的文件。

先写入日志文件，再写入数据库，可以确保数据的一致性、完整性和可靠性。

先写入日志文件也可以作为备份机制，提高性能并增强容错处理能力。

### 什么是数据库镜像？它有什么用途？

数据库镜像是一种技术，用于创建一个数据库的实时副本，保证镜像数据和主数据的一致性。

作用
1. 提高系统可用性
2. 灾难恢复
3. 负载均衡
4. 实时备份
5. 升级测试

### 什么是数据仓库？
数据仓库是一个面向主题的、集成的、相对稳定的、反映历史变化的数据集合，用于支持管理决策。
数据仓库的数据来源多样，经过一定的规则转换得到的，用于分析和决策。
数据库擅长于事务型工作，数据仓库擅长于分析型工作。
抽取-> 转换-> 加载

数据湖用于存放原始数据，数据仓库是已经被过滤处理之后的数据
### 数据库语句`delete`和`drop`的区别是什么？

1. DELETE用于删除行级别的记录，而DROP用于删除表级别的对象。简单来说，DELETE删除的是表中的数据，而DROP则删除整个表及其关联的数据和对象。
2. 用DELETE之后，被删除的记录将被移除，但表结构和其它数据不受影响。这意味着可以在以后再重新插入数据。使用DROP后，将导致整个表和所有其它数据库对象丢失，除非您事先备份了它们，否则就是很难去恢复。
3. 使用DELETE之后，被删除的记录仍旧保存在数据库日志中，可以通过恢复日志来找回它们。但是，在使用DROP后，已删除的数据无法被恢复，甚至在备份中也无法找回。
4. DELETE删除表中的数据时，表文件在磁盘上所占空间不会变小，存储空间不会被释放，只是把删除的数据行设置为不可见，而DROP语句删除表结构及所有数据，并将表所占用的空间全部释放。
5. DELETE属于数据库DML操作语言，会走事务，执行时会触发触发器，而DROP语句是一个DDL操作，用于直接删除一个或多个表、索引、视图等对象。

### 什么是数据库模式？
> 描述了数据库中存储的数据结构和数据之间的关系
包含
1. 实体关系模型
2. 表结构
3. 键和约束
4. 视图
5. 存储过程和触发器
### 数据库的三级模式和是什么？数据库系统的三级模式结构

- 外模式
也称为用户模式，是用户或应用程序能够看到和访问的数据库的部分。 

用户能操作到的数据
- 概念模式
也称为全局模式，是数据库的整体逻辑结构和组织方式的描述。

逻辑关系
- 内模式
也称为存储模式，是数据库存储在物理介质上的实际存储结构和存取路径的描述。

存储方式

### 什么是数据库的两级映像和数据库的数据独立性？
> 实现了数据的抽象和隔离
外模式/模式 逻辑独立性
模式/内模式 物理独立性

- 逻辑独立性
指应用程序和逻辑结构之间的独立性，修改了数据库的概念模型不会影响到应用程序，提高了系统的灵活性  。
- 物理独立性
数据的逻辑结构和物理结构之间的独立性，修改数据库的物理存储结构不会影响到逻辑结构和应用程序。

### 数据库的活锁与死锁是什么？
活锁（Deadlock）是指系统中的若干进程或线程因争夺资源而陷入一种循环等待的状态，导致它们无法继续执行下去
- 有一个事务一直在等待资源无法执行。

使用FIFO避免活锁
- 死锁是指两个或两个以上的进程在执行过程中，由于竞争资源或者彼此通信而造成的一种阻塞现象。若无外力作用，这些进程都将无法推进下去。

预防死锁
- 一次封锁法

一次需要的东西全部加锁，否则就不执行

缺点 降低并发量，难以精确的预估需要使用多少资源
- 顺序封锁法

按照一定顺序来封锁，必须锁数据1之后才能锁数据2

缺点 维护成本高  难以实现

诊断死锁
- 超时法

超出时间就认为是死锁，但是会误判一些执行时间较长的事务
- 事务等待图法

如果出现了回路就出现了死锁

死锁产生的四个必要条件如下：

- 互斥条件：进程要求对所分配的资源（如打印机）进行排他性控制，即在一段时间内某资源仅为一个进程所占有。此时，若其他进程请求该资源，请求进程只能等待。
- 不剥夺条件：进程所获得的资源在未使用完毕之前，不能被其他进程强行夺走，只能由获得该资源的进程自己来释放。
- 请求和保持条件：进程已经保持了至少一个资源，但又提出了新的资源请求，而该资源已被其他进程占有。此时，请求进程被阻塞，但对自己已获得的资源保持不放。
- 循环等待条件：存在一种进程资源的循环等待链，链中每一个进程已获得的资源同时被链中下一个进程所请求。
### 数据库的DBA和DBMS的作用是什么？

1. 数据库管理员（DBA）负责管理数据库系统，包括设计、安全、性能优化和故障排除。
2. 数据库管理系统（DBMS）是一种软件工具，用于管理和操作数据库，包括数据的定义、创建、维护和控制访问。


#### 系统故障的恢复
::: info tip
系统故障的恢复由系统在重新启动后自动完成。
:::
做法
1. UNDO故障发生时未完成的事务
2. REDO已完成的事务
   
步骤
1. 正向扫描日志文件，故障前开始前已经提交的事务，加入重做队列。还未完成的事务，加入撤销队列
2. 撤销事务进行撤销处理 （反向扫描）
3. 重做事务进行重做处理 （正向扫描）
#### 介质故障的恢复
用副本来替换坏的介质，并根据日志来恢复丢失的数据。

